name: Python package

on:
  push:
    tags: '*'
    brunch: [main]

jobs:
  build:
    timeout-minutes: 10
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            exe_name: kougei-config
            artifact_name: kougei-config_linux_x64.tgz
          - os: windows-latest
            exe_name: kougei-config.exe
            artifact_name: kougei-config_windows_x64.zip
          - os: macOS-latest
            exe_name: kougei-config
            artifact_name: kougei-config_mac_darwin.tgz
        python-version: ["3.9", "3.10"]
  steps:
  - uses: actions/checkout@v3
  - name: Set up Python ${{ matrix.python-version }}
    uses: actions/setup-python@v3
    with:
      python-version: ${{ matrix.python-version }}
  - name: Install dependencies
    run: |
     python -m pip install --upgrade pip
     pip install nuitka
     if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
  - name: Build with nuitka
    run: |
      nuitka --follow-imports --onefile kougei-config.py
  - name: Package
    shell: bash
    run: |
      ls  '${{github.workspace}}'
      if [[ "${{ matrix.os }}" == "windows-latest" ]]
      then
        7z a ${{ matrix.artifact_name }} '${{github.workspace}}/build/Release/${{ matrix.exe_name }}'
      else
        tar czvf ${{ matrix.artifact_name }} ${{github.workspace}}/build/${{ matrix.exe_name }}        fi
        ls
  - name: Upload Artifacts
    uses: actions/upload-artifact@v3
    with:
     name: ${{ matrix.artifact_name }}
     path: ${{ matrix.artifact_name }}
  - name: Release
    uses: softprops/action-gh-release@v1
    if: startsWith(github.ref, 'refs/tags/')
    with:
    files: |
      ${{ matrix.artifact_name }}
      LICENSE